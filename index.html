<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Maps com Autocomplete</title>
  <style>
    #map {
      height: 80vh; /* Altura do mapa */
      width: 100%;   /* Largura do mapa */
    }
    #controls {
      margin: 10px;
      display: flex;
      justify-content: center;
    }
    #autocomplete {
      width: 300px;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input id="autocomplete" type="text" placeholder="Digite um endereço">
  </div>
  <div id="map"></div>

  <script>
    let map;
    let marker;
    let polygon;

    function initMap() {
      
      // Inicializa o mapa
      const center = { lat: 35.96486155557068, lng: -78.27706574805066 }; // USA
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: center,
      });

     
      // Inicializa o marcador vazio
      marker = new google.maps.Marker({
        map: map,
      });

       // Lista de arquivos CSV a serem lidos
       const files = [
        './files_csv/border-street.csv',
        './files_csv/boston-city.csv',
        //'./files_csv/suffolk-county.csv',
      ];

      // Ler e processar cada arquivo
      files.forEach((file) => {
        fetch(file)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Erro ao carregar o arquivo: ${file}`);
            }
            return response.text();
          })
          .then((data) => {
            processCSV(data);
          })
          .catch((error) => console.error(error));
      });
      

      // Adiciona a funcionalidade de autocomplete
      const autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("autocomplete"),
        {
          //types: ["geocode"], // Sugere apenas endereços
          types: ["(regions)"],
          componentRestrictions: { country: ["br","us"] },
        }
      );

      // Evento de seleção no autocomplete
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();

        // Verifica se o lugar possui coordenadas
        if (!place.geometry || !place.geometry.location) {
          alert("Por favor, selecione um local válido.");
          return;
        }

        // Atualiza o mapa e marcador para a localização escolhida
        map.setCenter(place.geometry.location);
        map.setZoom(15);
        
        // Remove o polígono anterior, se existir
        if (polygon) {
          polygon.setMap(null);
        }

        // Destaca o bairro
        highlightNeighborhood(place.geometry.location);

        marker.setPosition(place.geometry.location);
        marker.setTitle(place.formatted_address);
      });
      
    }

    function getCityState(address) {
      let cs = '';

      // this is not foolproof.. do a deep dive into the address components
      // and their type, if you are going to be more thorough.. I am just
      // working off of the formatted address
      // more info at https://developers.google.com/maps/documentation/geocoding/start?csw=1
      address.map(curAddress => {        
        if (curAddress.types[0] === "locality") {
          cs = cityStateHelper(curAddress.formatted_address);
        }
      });
      
      return cs;
    }

    function cityStateHelper(str) {
      let city = '';
      let state = '';

      if (!str) return '';

      const addressParts = str.split(',');
      city = addressParts[0];
      // just the first two characters...
      state = addressParts[1].trim().substring(0,2);
      return `${city},${state}`;
    }

    // Função para destacar o bairro
    function highlightNeighborhood(location) {
      const geocoder = new google.maps.Geocoder();
    
      // Usa Geocoding para obter informações detalhadas
      geocoder.geocode({ location: location }, (results, status) => {
        if (status === "OK" && results[0]) {

          // parse the address to get city and state
          let cityState = getCityState(results);
          
          // Itera pelos resultados para encontrar o bairro
          const addressComponents = results[0].address_components;
          let neighborhood = cityState;
    
          debugger

          addressComponents.forEach((component) => {
            if (component.types.includes("sublocality") || component.types.includes("neighborhood")) {
              neighborhood = component.long_name;
            }
          });
    
          debugger
          
          if (neighborhood) {
            console.log(`Bairro encontrado: ${neighborhood}`);

            let apiPath = "https://nominatim.openstreetmap.org/search.php";
            let params = {
              //q: `${theCity},USA`,
              q: `${neighborhood}`,
              polygon_geojson: 1,
              format: "json"
            };

            console.log(params);

            let polygonType = null;

            axios.get(apiPath, { params: params }  )
                .then(response => {
                  debugger
                  let responseIndex = getCityIndex(response.data);
                  debugger
                  let geoJSONDataChunk = response.data[responseIndex];
                  debugger
                  polygonType = geoJSONDataChunk?.geojson.type || null;
        
                  // geojson data from http://nominatim.openstreetmap.org/ needs
                  // to be wrapped, so that the google addGeoJson() call
                  // can handle it properly
                  const geoConf = {
                    "type": "FeatureCollection",
                    "features": [
                      { "type": "Feature",
                        "geometry": geoJSONDataChunk?.geojson,
                        "id": "city"
                      }
                    ]
                  };
                  /*
                  const geojson = {
                    type: "FeatureCollection",
                    features: [
                      {
                        type: "Feature",
                        properties: { name: "Bairro 1" },
                        geometry: {
                          type: "Polygon",
                          coordinates: [
                            [
                              [-46.6333, -23.5505],
                              [-46.6433, -23.5505],
                              [-46.6433, -23.5605],
                              [-46.6333, -23.5605],
                              [-46.6333, -23.5505],
                            ],
                          ],
                        },
                      },
                      {
                        type: "Feature",
                        properties: { name: "Bairro 2" },
                        geometry: {
                          type: "Polygon",
                          coordinates: [
                            [
                              [-46.6533, -23.5405],
                              [-46.6633, -23.5405],
                              [-46.6633, -23.5505],
                              [-46.6533, -23.5505],
                              [-46.6533, -23.5405],
                            ],
                          ],
                        },
                      },
                    ],
                  };
                  */

                  debugger
                  // Adiciona o GeoJSON ao mapa
                  map.data.addGeoJson(geoConf);
            
                  // Define o estilo dos polígonos
                  map.data.setStyle({
                    fillColor: "#FF0000",
                    strokeColor: "#000000",
                    strokeWeight: 1,
                    fillOpacity: 0.35,
                  });
                });
            

            /*
            // Usa o viewport como alternativa ao bounds
            const viewport = results[0].geometry.viewport;
    
            // Cria o polígono a partir das coordenadas do viewport
            const sw = viewport.getSouthWest();
            const ne = viewport.getNorthEast();
    
            // Remove o polígono anterior, se existir
            if (polygon) {
              polygon.setMap(null);
            }
    
            // Desenha um retângulo para destacar a área
            polygon = new google.maps.Rectangle({
              bounds: {
                north: ne.lat(),
                south: sw.lat(),
                east: ne.lng(),
                west: sw.lng(),
              },
              strokeColor: "#FF0000",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "#FF0000",
              fillOpacity: 0.35,
              map: map,
            });
            */
          } else {
            alert("Não foi possível identificar o bairro.");
          }
        } else {
          console.error("Geocoding falhou:", status);
        }
      });
    }

    function getCityIndex(data) {
      let retIndex = null;
      let adminIndex = null;

      console.log(data);

      data.map((curData, index) => {
        // console.log(curData.type);
        switch(curData.type) {
          case "city":
            retIndex = index;
            break;
          case "administrative":
            adminIndex = index;
            break;
          default:
            break;
        }
      });

      // ... we punt to administrative...
      if (retIndex === null && adminIndex !== null) {
        retIndex = adminIndex;
      }

      return retIndex;
    }

    // Processa o conteúdo do CSV e adiciona marcadores no mapa
    function processCSV(data) {
      const lines = data.split("\n");
      lines.forEach((line) => {
        const [lat, lng] = line.split(",").map((value) => value.trim());
        if (!isNaN(lat) && !isNaN(lng)) {
          addMarker(parseFloat(lat), parseFloat(lng));
        }
      });
    }

    // Adiciona um marcador no mapa
    function addMarker(lat, lng) {
      new google.maps.Marker({
        position: { lat, lng },
        map: map,
      });
    }
  
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.1/axios.min.js"></script>

  <!-- Carrega a API do Google Maps com a Places API habilitada -->
  <script 
    src="https://maps.googleapis.com/maps/api/js?key=TOKEN&libraries=places&callback=initMap"
    async
    defer>
  </script>
</body>
</html>
